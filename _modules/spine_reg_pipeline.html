
<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spine_reg_pipeline &#8212; Spine Image Registration  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../_static/bizstyle.css?v=5283bb3d" />
    
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Spine Image Registration  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spine_reg_pipeline</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spine_reg_pipeline</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">spine_reg</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span> <span class="c1"># TODO: Add path argument in final version</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>

<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../spine_reg_pipeline.html#spine_reg_pipeline.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command Line Arguments:</span>
<span class="sd">    =======================</span>
<span class="sd">    fname_I : str</span>
<span class="sd">        The path to the interpolated atlas .npz file to be used for registration</span>
<span class="sd">    fname_L : str</span>
<span class="sd">        The path to the interpolated atlas labels .npz file to be used for registration</span>
<span class="sd">    fname_J : str</span>
<span class="sd">        The path to the spine reflection .npz file to be registered</span>
<span class="sd">    fname_pointsJ : str</span>
<span class="sd">        The path to an .swc file used for more precise registration of J</span>
<span class="sd">    outdir : str</span>
<span class="sd">        The directory where all output files should be saved</span>
<span class="sd">    e_path : str</span>
<span class="sd">        The location of the custom Python library \&#39;emlddmm\&#39;, which can be cloned from GitHub at https://github.com/twardlab/emlddmm</span>
<span class="sd">    -device : str</span>
<span class="sd">        Default - cpu; The device where registration computations should occur</span>
<span class="sd">    -dtype : torch.dtype</span>
<span class="sd">        Default - torch.float32; The data type used for the voxel values in image registration</span>
<span class="sd">    -niter : int</span>
<span class="sd">        Default - 5000; The number of iterations to use for image registration</span>
<span class="sd">    -down : list of int</span>
<span class="sd">        Default - [8,8,8]; The factor used to downsample along each axis of I, respectively</span>
<span class="sd">    -blocksize : int</span>
<span class="sd">        Default - 50; TODO: ...</span>
<span class="sd">    -verbose : bool</span>
<span class="sd">        Default - False; If present, print out several progress messages throughout the registration process</span>
<span class="sd">    -saveAllFigs : bool</span>
<span class="sd">        Default - False; If present, save every intermediate figure generated before, during, and after registration</span>
<span class="sd">    -saveIntermediateFigs : bool</span>
<span class="sd">        Default - false; If present, save intermediate figures at each iteration of the registration process</span>
<span class="sd">    -saveFig0 : bool</span>
<span class="sd">        Default - False; If present, save a MIP of the interpolated atlas provided</span>
<span class="sd">    -saveFig1 : bool</span>
<span class="sd">        Default - False; If present, save a MIP of the interpolated atlas labels provided</span>
<span class="sd">    -saveFig2 : bool</span>
<span class="sd">        Default - False; If present, save a scatter plot of all the points labeled in the interpolated atlas porvided</span>
<span class="sd">    -saveFig3 : bool</span>
<span class="sd">        Default - False; If present, save a standard view of the target data along all 3 cardinal axes</span>
<span class="sd">    -saveFig4 : bool</span>
<span class="sd">        Default - False; If present, save a MIP of the target data along all 3 cardinal axes</span>
<span class="sd">    -saveFig5 : bool</span>
<span class="sd">        Default - False; If present, save a standard view of the target data along all 3 cardinal axes</span>
<span class="sd">    -saveFig6 : bool</span>
<span class="sd">        Default - False; If present, save a standard view of the target data along all 3 cardinal axes</span>
<span class="sd">    -saveFig7 : bool</span>
<span class="sd">        Default - False; If present, save a save a scatter plot of all points along the AP axis</span>
<span class="sd">    -saveFig8 : bool</span>
<span class="sd">        Default - False; If present, save a standard view of the qJU object along the AP axis</span>
<span class="sd">    -saveFig9 : bool</span>
<span class="sd">        Default - False; If present, save a save a standard view of the qJU object along the AP axis with points superimposed</span>
<span class="sd">    -saveFig10 : bool</span>
<span class="sd">        Default - False; If present, save a save a standard view of the downsampled target data along all 3 cardinal axes</span>
<span class="sd">    -saveFig11 : bool</span>
<span class="sd">        Default - False; If present, save a save a plot of the xv*xId object</span>
<span class="sd">    -saveFig12 : bool</span>
<span class="sd">        Default - False; If present, save a save a plot of the B object</span>
<span class="sd">    -saveFig13 : bool</span>
<span class="sd">        Default - False; If present, save a color gradient</span>
<span class="sd">    -saveFig14 : bool</span>
<span class="sd">        Default - False; If present, save a color gradient</span>
<span class="sd">    -saveFig15 : bool</span>
<span class="sd">        Default - False; If present, save a color gradient</span>
<span class="sd">    -saveFig16 : bool</span>
<span class="sd">        Default - False; If present, save a color gradient</span>

<span class="sd">    Raises:</span>
<span class="sd">    =======</span>
<span class="sd">    Exception</span>
<span class="sd">        If any of the 8 input files do not have the correct file extension</span>
<span class="sd">    Exception</span>
<span class="sd">        If a negative Jacobian arises during the registration loop</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;fname_I&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;The path to the interpolated atlas .npz file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;fname_L&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;The path to the interpolated atlas labels .npz file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;fname_J&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;The path to the spine reflection .npz file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;fname_pointsJ&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;The input .swc file used for more precise registration&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;outdir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;The directory where all output files should be saved&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;e_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span> <span class="s1">&#39;The location of the custom Python library </span><span class="se">\&#39;</span><span class="s1">emlddmm</span><span class="se">\&#39;</span><span class="s1">, which can be cloned from GitHub at https://github.com/twardlab/emlddmm&#39;</span><span class="p">)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-device&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - cpu; The device where registration computations should occur&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-dtype&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - torch.float32; The data type used for image registration&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-niter&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - 5000; The number of iterations to use for image registration&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-down&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;The factor used to downsample along each axis of I, respectively&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-bs&#39;</span><span class="p">,</span> <span class="s1">&#39;--blocksize&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;TODO: ...&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, print out several progress messages throughout the registration process&#39;</span><span class="p">)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveAllFigs&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save every intermediate figure generated before, during, and after registration&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveIntermediateFigs&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - false; If present, save intermediate figures at each iteration of the registration process&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig0&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a MIP of the interpolated atlas provided&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig1&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a MIP of the interpolated atlas labels provided&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig2&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a scatter plot of all the points labeled in the interpolated atlas porvided&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig3&#39;</span><span class="p">,</span>  <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a standard view of the target data along all 3 cardinal axes&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig4&#39;</span><span class="p">,</span>  <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a MIP of the target data along all 3 cardinal axes&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig5&#39;</span><span class="p">,</span>  <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a standard view of the target data along all 3 cardinal axes&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig6&#39;</span><span class="p">,</span>  <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a standard view of the target data along all 3 cardinal axes&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig7&#39;</span><span class="p">,</span>  <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a scatter plot of all points along the AP axis&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig8&#39;</span><span class="p">,</span>  <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a standard view of the qJU object along the AP axis&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig9&#39;</span><span class="p">,</span>  <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a standard view of the qJU object along the AP axis with points superimposed&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig10&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a standard view of the downsampled target data along all 3 cardinal axes&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig11&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a plot of the xv*xId object&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig12&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a plot of the B object&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig13&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a color gradient&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig14&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a color gradient&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig15&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a color gradient&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-saveFig16&#39;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Default - False; If present, save a color gradient&#39;</span><span class="p">)</span>
    
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">fname_I</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fname_I</span>
    <span class="n">fname_L</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fname_L</span>
    <span class="n">fname_J</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fname_J</span>
    <span class="n">fname_pointsJ</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fname_pointsJ</span>
    <span class="n">outdir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span>
    <span class="n">e_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">e_path</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">niter</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">niter</span>
    <span class="n">down</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">down</span>
    <span class="n">blocksize</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">blocksize</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
    
    <span class="n">saveAllFigs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveAllFigs</span>
    <span class="n">saveIntermediateFigs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveIntermediateFigs</span>
    <span class="n">saveFig0</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig0</span>
    <span class="n">saveFig1</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig1</span>
    <span class="n">saveFig2</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig2</span>
    <span class="n">saveFig3</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig3</span>
    <span class="n">saveFig4</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig4</span>
    <span class="n">saveFig5</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig5</span>
    <span class="n">saveFig6</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig6</span>
    <span class="n">saveFig7</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig7</span>
    <span class="n">saveFig8</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig8</span>
    <span class="n">saveFig9</span>  <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig9</span>
    <span class="n">saveFig10</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig10</span>
    <span class="n">saveFig11</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig11</span>
    <span class="n">saveFig12</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig12</span>
    <span class="n">saveFig13</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig13</span>
    <span class="n">saveFig14</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig14</span>
    <span class="n">saveFig15</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig15</span>
    <span class="n">saveFig16</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">saveFig16</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_path</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">emlddmm</span>

    <span class="c1"># Create outdir if it doesn&#39;t already exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># =================================================</span>
    <span class="c1"># ===== Perform validity checks on parameters =====</span>
    <span class="c1"># =================================================</span>
    <span class="k">if</span> <span class="s1">&#39;.npz&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fname_I</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fname_I</span><span class="si">}</span><span class="s1"> should be a .npz file&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;.npz&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fname_L</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fname_L</span><span class="si">}</span><span class="s1"> should be a .npz file&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;.npz&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fname_J</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fname_J</span><span class="si">}</span><span class="s1"> should be a .npz file&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;.swc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fname_pointsJ</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fname_pointsJ</span><span class="si">}</span><span class="s1"> should be a .swc file&#39;</span><span class="p">)</span>
        
    <span class="c1"># ===================================</span>
    <span class="c1"># ===== Load interpolated atlas =====</span>
    <span class="c1"># ===================================</span>
    <span class="n">data_I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname_I</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">data_I</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
    <span class="n">xI</span> <span class="o">=</span> <span class="n">data_I</span><span class="p">[</span><span class="s1">&#39;xI&#39;</span><span class="p">]</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">I</span> <span class="o">/</span> <span class="n">I</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Normalize atlas values</span>

    <span class="n">lowert</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="c1"># This is an atlas-dependent parameter - locally found at /nafs/dtward/spine_work/interpolated_atlas.npz</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">I</span><span class="o">&lt;</span><span class="n">lowert</span>
    <span class="n">I</span><span class="p">[</span><span class="n">M</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">I</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">I</span> <span class="o">-</span> <span class="n">lowert</span>
    <span class="n">I</span><span class="p">[</span><span class="n">I</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">I</span> <span class="o">=</span> <span class="n">I</span><span class="o">/</span><span class="n">I</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig0</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">draw</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">xI</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">getslice</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig0_interp_atlas.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully loaded atlas file . . .&#39;</span><span class="p">)</span>

    <span class="c1"># ==========================================</span>
    <span class="c1"># ===== Load interpolated atlas labels =====</span>
    <span class="c1"># ==========================================</span>
    <span class="n">data_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname_L</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">data_L</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">256</span>
    <span class="n">xL</span> <span class="o">=</span> <span class="n">data_L</span><span class="p">[</span><span class="s1">&#39;xI&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig1</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">draw</span><span class="p">((</span><span class="n">L</span><span class="o">%</span><span class="mi">256</span><span class="p">)</span><span class="o">==</span><span class="mi">16</span><span class="p">,</span><span class="n">xI</span><span class="p">,)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig1_interp_atlas_labels.png&#39;</span><span class="p">))</span>

    <span class="n">qIU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">xI</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)[(</span><span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="mi">256</span><span class="p">)</span><span class="o">==</span><span class="mi">16</span><span class="p">]</span>
    <span class="n">nqU</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># TODO: Decide if this should be a passable argument</span>
    <span class="n">qIU</span> <span class="o">=</span> <span class="n">qIU</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">qIU</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:</span><span class="n">nqU</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig2</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">qIU</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig2_scattered_labels.png&#39;</span><span class="p">))</span>

    <span class="n">SigmaQIU</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="n">qIU</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">qIU</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">d2i</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">d2i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">d2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">d2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">SigmaQIU</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d2i</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">SigmaQIU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SigmaQIU</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully loaded atlas labels file . . .&#39;</span><span class="p">)</span>

    <span class="c1"># =====================================================================</span>
    <span class="c1"># ===== Load the target image data to be registered + axis values =====</span>
    <span class="c1"># =====================================================================</span>
    <span class="k">try</span> <span class="p">:</span>
        <span class="n">data_J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname_J</span><span class="p">,</span> <span class="n">allow_pickle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">data_J</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
        <span class="n">xJ</span> <span class="o">=</span> <span class="n">data_J</span><span class="p">[</span><span class="s1">&#39;xI&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">:</span>    
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname_J</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">,</span><span class="s1">&#39;_I.npy&#39;</span><span class="p">))</span>
        <span class="n">xJ</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname_J</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">,</span><span class="s1">&#39;_xI0.npy&#39;</span><span class="p">)),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname_J</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">,</span><span class="s1">&#39;_xI1.npy&#39;</span><span class="p">)),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname_J</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">,</span><span class="s1">&#39;_xI2.npy&#39;</span><span class="p">)),</span>
        <span class="p">]</span>

    <span class="c1"># If necessary, add a 4th dimension to J</span>
    <span class="k">if</span> <span class="n">J</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="c1"># Readjust coordinate axes to be centered about 0</span>
    <span class="n">xJ</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xJ</span><span class="p">]</span>
    
    <span class="c1"># Normalize J</span>
    <span class="n">Jsave</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">low</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># TODO: ADD AS ARG</span>
    <span class="n">high</span> <span class="o">=</span> <span class="mi">1500</span> <span class="c1"># TODO: ADD AS ARG</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">Jsave</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">low</span><span class="p">,</span><span class="n">high</span><span class="p">)</span>
    <span class="n">WJ</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">J</span> <span class="o">==</span> <span class="n">high</span><span class="p">)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">J</span> <span class="o">-</span> <span class="n">low</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">J</span> <span class="o">/</span> <span class="p">(</span><span class="n">high</span><span class="o">-</span><span class="n">low</span><span class="p">)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="o">*</span><span class="n">WJ</span>
    <span class="n">WJ</span> <span class="o">=</span> <span class="n">WJ</span><span class="o">*</span><span class="mi">0</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">sl</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span><span class="nb">slice</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span><span class="nb">slice</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="o">-</span><span class="mi">110</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span><span class="nb">slice</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="o">-</span><span class="mi">310</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig3</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">draw</span><span class="p">((</span><span class="n">J</span><span class="o">*</span><span class="n">WJ</span><span class="p">)[</span><span class="n">sl</span><span class="p">],[</span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">xJ</span><span class="p">)],</span><span class="n">function</span><span class="o">=</span><span class="n">getslice</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig3_target_slice0.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig4</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">draw</span><span class="p">((</span><span class="n">J</span><span class="o">*</span><span class="n">WJ</span><span class="p">)[</span><span class="n">sl</span><span class="p">],[</span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">xJ</span><span class="p">)])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig4_target_MIP.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig5</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">draw</span><span class="p">(</span><span class="n">J</span><span class="o">*</span><span class="n">WJ</span><span class="p">,</span><span class="n">xJ</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">getslice</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig5_target_slice1.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig6</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">draw</span><span class="p">(</span><span class="n">WJ</span><span class="p">,</span><span class="n">xJ</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">getslice</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig6_target_slice2.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully loaded target image data and axes files . . .&#39;</span><span class="p">)</span>

    <span class="c1"># Initialzie qJU, which is a set of unlabeled points associated with the target image</span>
    <span class="n">qJU</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_pointsJ</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span> 
                <span class="k">continue</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> 
            <span class="n">qi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">items</span><span class="p">])</span>
            <span class="n">qJU</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qi</span><span class="p">)</span>
    <span class="n">qJU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">qJU</span><span class="p">)</span>
    <span class="n">qJU</span> <span class="o">=</span> <span class="n">qJU</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="n">qJU</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="n">nqU</span><span class="p">)]</span>
    <span class="n">qJU</span> <span class="o">=</span> <span class="n">qJU</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">qJU</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig7</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">qJU</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig7_qJU_scatter.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig8</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">xJ</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qJU</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">qJU</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig8_qJU0.png&#39;</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig9</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">J</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">xJ</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qJU</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">qJU</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig9_qJU1.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully loaded target image points file . . .&#39;</span><span class="p">)</span>

    <span class="c1"># =========================</span>
    <span class="c1"># ===== Preprocessing =====</span>
    <span class="c1"># =========================</span>

    <span class="c1"># Downsample the atlas image, I, and target iamge, J</span>
    <span class="n">xId</span><span class="p">,</span><span class="n">Id</span> <span class="o">=</span> <span class="n">emlddmm</span><span class="o">.</span><span class="n">downsample_image_domain</span><span class="p">(</span><span class="n">xI</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">down</span><span class="p">)</span>
    <span class="n">xJd</span><span class="p">,</span><span class="n">Jd</span><span class="p">,</span><span class="n">WJd</span> <span class="o">=</span> <span class="n">emlddmm</span><span class="o">.</span><span class="n">downsample_image_domain</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xJ</span><span class="p">,</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">:])],</span><span class="n">J</span><span class="p">[</span><span class="n">sl</span><span class="p">],</span><span class="n">down</span><span class="p">,</span><span class="n">W</span><span class="o">=</span><span class="n">WJ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>    

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig10</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">draw</span><span class="p">(</span><span class="n">Jd</span><span class="o">*</span><span class="n">WJd</span><span class="p">,</span><span class="n">xJd</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">getslice</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig10_target_down.png&#39;</span><span class="p">))</span>

    <span class="c1"># Convert input data from Numpy to torch format</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;device&#39;</span><span class="p">:</span><span class="n">device</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span><span class="n">dtype</span><span class="p">}</span>
    <span class="n">Id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
    <span class="n">Jd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Jd</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
    <span class="n">xId</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xId</span><span class="p">]</span>
    <span class="n">xJd</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xJd</span><span class="p">]</span>
    <span class="n">WJd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">WJd</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
    
    <span class="n">XId</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xId</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">XJd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xJd</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">nId</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Id</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:],</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="c1"># int</span>
    
    <span class="n">qIU</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">qIU</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
    <span class="n">qJU</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">qJU</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
    <span class="n">SigmaQIU</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">SigmaQIU</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>

    <span class="c1"># Initialize parameters for deformation portion of registration</span>
    <span class="c1"># TODO: Add nt, a, and p as arguments uaing the below values for default</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">nt</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">200.0</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">expand</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.02</span><span class="p">,</span><span class="mf">1.2</span><span class="p">,</span><span class="mf">1.2</span><span class="p">]</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="mf">0.5</span>
    <span class="n">vminmax</span> <span class="o">=</span> <span class="p">[(</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xId</span><span class="p">]</span>
    <span class="n">vr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vminmax</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">vc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vminmax</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">vminmax</span> <span class="o">=</span> <span class="n">vc</span> <span class="o">+</span> <span class="p">(</span><span class="n">vr</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">expand</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">))</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="o">**</span><span class="n">dd</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span>
    <span class="n">xv</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dv</span><span class="p">)</span> <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vminmax</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>
    <span class="n">XV</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nv</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xv</span><span class="p">]</span>
    <span class="n">fv</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="n">dv</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">XV</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
    <span class="n">FV</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">fv</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>  <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">FV</span><span class="o">*</span><span class="n">dv</span><span class="p">))</span><span class="o">/</span><span class="n">dv</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>   <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">LL</span>    
    <span class="n">v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span><span class="o">*</span><span class="n">nv</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
    <span class="n">squish</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">)</span> <span class="c1"># exponentiate it (-0.1 was good), -1 makes it very short and fat in the coronal plane</span>
    <span class="n">squish</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="p">(</span><span class="n">xv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">xId</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">5000</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="p">(</span><span class="n">xv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">xId</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">2000</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">squishb</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@squish</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig11</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">squish</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xId</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">squishb</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig11_xv_xId.png&#39;</span><span class="p">))</span>
        

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig12</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>        
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig12_B.png&#39;</span><span class="p">))</span>

    <span class="c1"># Initalize the final permutation</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">P</span>
    <span class="n">A</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">stretch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span><span class="o">-</span><span class="mf">0.75</span><span class="p">],</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># the third number, in the coronal plane, makes it grow left right if it is positive</span>

    <span class="c1"># Define a metric for affine, since coordinate system is centered at 0, my off diagonal terms will be 0 in the standard push forward approach</span>
    <span class="c1"># for two basis matrices, we need to evaluate:</span>
    <span class="c1">#     gij = int (Eix)^T   Ejx dx = int trace [  x^T Ei^T Ej x ] dx =  int trace [xx^T Ei^TEj]dx = trace [ int xx^T dx Ei^TEj ]</span>
    <span class="n">XX</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">XId</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">XId</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">,:],(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">XId</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">XXO</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">XX</span><span class="p">),</span><span class="n">O</span><span class="p">[</span><span class="kc">None</span><span class="p">])))</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">Eij</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span><span class="o">==</span><span class="n">i</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span><span class="o">==</span><span class="n">j</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="mf">1.0</span>
            <span class="n">count_</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                    <span class="n">Eij_</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span><span class="o">==</span><span class="n">i_</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span><span class="o">==</span><span class="n">j_</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="mf">1.0</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">count</span><span class="p">,</span><span class="n">count_</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span> <span class="n">XXO</span><span class="o">@</span><span class="p">(</span><span class="n">Eij</span><span class="o">.</span><span class="n">T</span><span class="nd">@Eij_</span><span class="p">)</span> <span class="p">)</span>
    
                    <span class="n">count_</span> <span class="o">+=</span> <span class="mi">1</span> 
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">gi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">dJd</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xJd</span><span class="p">]</span>

    <span class="c1"># ========================</span>
    <span class="c1"># ===== Registration ===== </span>
    <span class="c1"># ========================</span>
    <span class="n">figE</span><span class="p">,</span><span class="n">axE</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">axE</span> <span class="o">=</span> <span class="n">axE</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">figI</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">figErr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">figJ</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">draw</span><span class="p">(</span><span class="n">Jd</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span><span class="n">xJd</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">getslice</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">figJ</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">figJ</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    
    <span class="n">figQ</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">axQ</span> <span class="o">=</span> <span class="n">figQ</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">axQ</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
    <span class="n">axQ</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">qIU</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;qIU&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">axQ</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="c1"># Initialize output figures data structures for storing output data</span>
    <span class="n">nrow</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">ncol</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">figS</span><span class="p">,</span><span class="n">axS</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span><span class="n">ncol</span><span class="p">)</span>
    <span class="n">figS</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">axS</span> <span class="o">=</span> <span class="n">axS</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>        
    <span class="n">Esave</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Tsave</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># the max</span>
    <span class="n">squishsave</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thetasave</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vsave</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ALsave</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ATsave</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">update_v</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">vstart</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="c1"># Initalize various step sizes</span>
    <span class="c1"># TODO: All of these aside from measureMatchingSigma should be included</span>
    <span class="n">epv</span> <span class="o">=</span> <span class="mf">5e4</span>
    <span class="n">eptheta</span> <span class="o">=</span> <span class="mf">5e-4</span>
    <span class="n">epSquish</span> <span class="o">=</span> <span class="mf">2e-4</span>
    <span class="n">epT</span> <span class="o">=</span> <span class="mf">2e2</span>
    <span class="n">measureMatchingSigma</span> <span class="o">=</span> <span class="n">SigmaQIU</span><span class="o">*</span><span class="mi">5</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">sigmaM</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e5</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">sigmaR</span> <span class="o">=</span> <span class="mf">1e5</span>
    <span class="n">sigmaR</span> <span class="o">=</span> <span class="mf">2e5</span>
    <span class="n">sigmaQU</span> <span class="o">=</span> <span class="mf">1e-1</span><span class="o">*</span><span class="mi">50</span>    
    <span class="n">wIU</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">qIU</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="c1">#/qIU.shape[0]*qJU.shape[0]</span>
    <span class="n">EQU0</span> <span class="o">=</span> <span class="n">measure_matching_dot</span><span class="p">(</span><span class="n">qIU</span><span class="p">,</span><span class="n">wIU</span><span class="p">,</span><span class="n">qIU</span><span class="p">,</span><span class="n">wIU</span><span class="p">,</span><span class="n">measureMatchingSigma</span><span class="p">)</span> <span class="c1"># only compute once</span>

    <span class="c1"># Begin the registration loop over &#39;niter&#39; iterations</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">niter</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="n">vstart</span><span class="p">:</span>
            <span class="n">update_v</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">32</span>

        <span class="c1"># Clean up memory using garbage collection</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Xs0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">phii</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        
        <span class="c1"># Apply blurs to barious data structures </span>
        <span class="n">thetab</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@theta</span>
        <span class="n">Tb</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@T</span>
        <span class="n">squishb</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@squish</span>
    
        <span class="c1"># First, compute the inverse affine (Ai)</span>
        <span class="n">Ai</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">Ai</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="o">-</span><span class="n">stretch</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span><span class="nd">@Ai</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ai</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="nd">@XJd</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Ai</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Second, compute the squish</span>
        <span class="n">tosample</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Tb</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">squishb</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span><span class="n">thetab</span><span class="p">[</span><span class="kc">None</span><span class="p">]))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">xId</span><span class="p">,</span><span class="n">tosample</span><span class="p">,</span><span class="n">Xs</span><span class="p">,</span><span class="n">dd</span><span class="p">)</span>
        <span class="n">Ts</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">squishs</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">eye</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">),)[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">zo</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],</span><span class="o">**</span><span class="n">dd</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Ts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">],)</span>
        <span class="n">Tcat</span> <span class="o">=</span>  <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">z</span><span class="p">,</span><span class="n">Ts</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>    
        <span class="n">squishmat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag_embed</span><span class="p">(</span>  <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">squishs</span><span class="p">),(</span><span class="o">-</span><span class="n">squishs</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">(),(</span><span class="n">squishs</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()]</span> <span class="p">,</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">)],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetas</span><span class="p">)],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetas</span><span class="p">)],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">],</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">Xs</span> <span class="o">=</span> <span class="n">Xs</span> <span class="o">-</span> <span class="n">Tcat</span>    
        <span class="n">Xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">rotmat</span><span class="nd">@squishmat@Xs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Third, compute the diffeo</span>
        <span class="n">phii</span> <span class="o">=</span> <span class="n">phii_from_v</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xv</span><span class="p">,(</span><span class="n">phii</span><span class="o">-</span><span class="n">XV</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">Xs</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">Xs</span>
        <span class="n">phiI</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xId</span><span class="p">,</span><span class="n">Id</span><span class="p">,</span><span class="n">Xs</span><span class="p">)</span>
        <span class="n">phiiQJU</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xJd</span><span class="p">,</span><span class="n">Xs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">qJU</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">dphii</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">phiiQJU</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dphii</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Negative jacobian&#39;</span><span class="p">)</span>
        
        <span class="c1"># contrast</span>
        <span class="k">if</span> <span class="n">blocksize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jdpp</span> <span class="o">=</span> <span class="n">toblocks</span><span class="p">(</span><span class="n">Jd</span><span class="p">,</span><span class="n">blocksize</span><span class="p">)</span> <span class="c1"># this only needs to be done once</span>
            <span class="n">WJdpp</span> <span class="o">=</span> <span class="n">toblocks</span><span class="p">(</span><span class="n">WJd</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span><span class="n">blocksize</span><span class="p">)</span> <span class="c1"># only needs to be done once</span>
            <span class="n">phiIpp</span> <span class="o">=</span> <span class="n">toblocks</span><span class="p">(</span><span class="n">phiI</span><span class="p">,</span><span class="n">blocksize</span><span class="p">)</span> <span class="c1"># only needs to be done once</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">blocksize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">muI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">phiI</span><span class="o">*</span><span class="n">WJd</span><span class="p">)</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WJd</span><span class="p">)</span>
                <span class="n">muJ</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Jd</span><span class="o">*</span><span class="n">WJd</span><span class="p">)</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WJd</span><span class="p">)</span>
                <span class="n">varI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">phiI</span><span class="o">-</span><span class="n">muI</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">WJd</span><span class="p">)</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WJd</span><span class="p">)</span>
                <span class="n">covIJ</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">phiI</span><span class="o">-</span><span class="n">muI</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Jd</span><span class="o">-</span><span class="n">muJ</span><span class="p">)</span><span class="o">*</span><span class="n">WJd</span><span class="p">)</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WJd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">muI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">phiIpp</span><span class="o">*</span><span class="n">WJdpp</span><span class="p">,(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WJdpp</span><span class="p">,(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">muJ</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Jdpp</span><span class="o">*</span><span class="n">WJdpp</span><span class="p">,(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WJdpp</span><span class="p">,(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">varI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">phiIpp</span><span class="o">-</span><span class="n">muI</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">WJdpp</span><span class="p">,(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WJdpp</span><span class="p">,(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">covIJ</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">phiIpp</span><span class="o">-</span><span class="n">muI</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Jdpp</span><span class="o">-</span><span class="n">muJ</span><span class="p">)</span><span class="o">*</span><span class="n">WJdpp</span><span class="p">,(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WJdpp</span><span class="p">,(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">blocksize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fphiIpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">phiIpp</span><span class="o">-</span><span class="n">muI</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">varI</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span><span class="o">*</span><span class="n">covIJ</span> <span class="o">+</span> <span class="n">muJ</span>
            <span class="n">fphiI</span> <span class="o">=</span> <span class="n">fromblocks</span><span class="p">(</span><span class="n">fphiIpp</span><span class="p">,</span><span class="n">Jd</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fphiI</span> <span class="o">=</span> <span class="p">(</span><span class="n">phiI</span><span class="o">-</span><span class="n">muI</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">varI</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span><span class="o">*</span><span class="n">covIJ</span> <span class="o">+</span> <span class="n">muJ</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">fphiI</span><span class="o">-</span><span class="n">Jd</span><span class="p">)</span>
        <span class="n">EM</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">WJd</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span> <span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xJd</span><span class="p">]))</span> <span class="o">/</span><span class="n">sigmaM</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">ER</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">K</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">nt</span><span class="o">/</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="o">/</span><span class="n">sigmaR</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span> <span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xJd</span><span class="p">]))</span> 
    
        <span class="c1"># Point matching</span>
        <span class="n">EQU</span> <span class="o">=</span> <span class="p">(</span><span class="n">EQU0</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">measure_matching_dot</span><span class="p">(</span><span class="n">qIU</span><span class="p">,</span><span class="n">wIU</span><span class="p">,</span><span class="n">phiiQJU</span><span class="p">,</span><span class="n">dphii</span><span class="p">,</span><span class="n">measureMatchingSigma</span><span class="p">)</span> <span class="o">+</span> <span class="n">measure_matching_dot</span><span class="p">(</span><span class="n">phiiQJU</span><span class="p">,</span><span class="n">dphii</span><span class="p">,</span><span class="n">phiiQJU</span><span class="p">,</span><span class="n">dphii</span><span class="p">,</span><span class="n">measureMatchingSigma</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">sigmaQU</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">EM</span> <span class="o">+</span> <span class="n">ER</span> <span class="o">+</span> <span class="n">EQU</span>
        <span class="n">E</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">Esave</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">E</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span><span class="n">EM</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span><span class="n">ER</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span><span class="n">EQU</span><span class="o">.</span><span class="n">item</span><span class="p">()])</span>
    
        <span class="c1"># Draw the error figures</span>
        <span class="n">draw</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">*</span><span class="n">WJd</span><span class="p">,</span><span class="n">xJd</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">getslice</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">figErr</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">figErr</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">draw</span><span class="p">(</span><span class="n">fphiI</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span><span class="n">xJd</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">getslice</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">figI</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">figI</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        
        <span class="c1"># Update parameters + set gradients to 0</span>
        <span class="n">theta</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">theta</span><span class="o">.</span><span class="n">grad</span><span class="o">*</span><span class="n">eptheta</span>
        <span class="n">theta</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        
        <span class="n">T</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">T</span><span class="o">.</span><span class="n">grad</span><span class="o">*</span><span class="n">epT</span>
        <span class="n">T</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

        <span class="n">squish</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">squish</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">squish</span><span class="o">.</span><span class="n">grad</span><span class="o">*</span><span class="n">epSquish</span>
        <span class="n">squish</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        
        <span class="n">epStretch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">stretch</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">stretch</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">stretch</span><span class="o">.</span><span class="n">grad</span><span class="o">*</span><span class="n">epStretch</span>
        <span class="n">stretch</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
    
        <span class="k">if</span> <span class="n">update_v</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">K</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]),</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="n">epv</span>
            <span class="n">v</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        
        <span class="n">epA</span> <span class="o">=</span> <span class="mf">2e6</span>
        <span class="n">Agrad</span> <span class="o">=</span> <span class="p">(</span><span class="n">gi</span><span class="nd">@A</span><span class="o">.</span><span class="n">grad</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">epA</span><span class="o">*</span><span class="n">Agrad</span>
        <span class="n">A</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="n">ALsave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">ATsave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    
    
        <span class="c1"># Generate plots showing all relevant registration variables</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Esave</span><span class="p">)</span>
    
        <span class="n">thetasave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thetab</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">Tsave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Tb</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">squishsave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">squishb</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">vsave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Tsave</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;max T&quot;</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thetasave</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;max theta&quot;</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">squishsave</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;max squish&quot;</span><span class="p">)</span>
    
        <span class="n">axE</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vsave</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;max v&quot;</span><span class="p">)</span>
    
        <span class="n">axE</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ALsave</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;AL&quot;</span><span class="p">)</span>
    
        <span class="n">axE</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ATsave</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;AT&quot;</span><span class="p">)</span>
    
    
        <span class="n">axE</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Tb</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Tb&quot;</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thetab</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;thetab&quot;</span><span class="p">)</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">squishb</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">axE</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;squishb&quot;</span><span class="p">)</span>
        
        <span class="n">figE</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    
        <span class="n">axQ</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">axQ</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">qIU</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;qIU&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">axQ</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">phiiQJU</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;phiiQJU&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">axQ</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">figQ</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        
        <span class="n">nshow</span> <span class="o">=</span> <span class="n">nrow</span><span class="o">*</span><span class="n">ncol</span>            
        <span class="n">slices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Jd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nshow</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nshow</span><span class="p">):</span>
            <span class="n">Jshow</span> <span class="o">=</span> <span class="p">(</span><span class="n">Jd</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:,</span><span class="n">slices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="n">WJd</span><span class="p">[:,:,</span><span class="n">slices</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">Jshow</span> <span class="o">=</span> <span class="n">Jshow</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Jshow</span><span class="p">)</span>
            <span class="n">Ishow</span> <span class="o">=</span> <span class="n">fphiI</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:,</span><span class="n">slices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Jshow</span><span class="p">)</span>
            <span class="n">axS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">Jshow</span><span class="p">,</span><span class="n">Ishow</span><span class="p">,</span><span class="n">Jshow</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">axS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
        <span class="n">figS</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveIntermediateFigs</span><span class="p">:</span>
            <span class="n">figQ</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;out_Q_it_</span><span class="si">{</span><span class="n">it</span><span class="si">:</span><span class="s1">06d</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">))</span>
            <span class="n">figErr</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;out_err_it_</span><span class="si">{</span><span class="n">it</span><span class="si">:</span><span class="s1">06d</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">))</span>
            <span class="n">figS</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;out_S_it_</span><span class="si">{</span><span class="n">it</span><span class="si">:</span><span class="s1">06d</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">))</span>
        
    <span class="c1"># =====================================        </span>
    <span class="c1"># ===== Save all relevant outputs =====</span>
    <span class="c1"># =====================================</span>

    <span class="c1"># First, save the final registered versions of all relevant parameters</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;saved_parameters.npz&#39;</span><span class="p">),</span>
             <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
             <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
             <span class="n">squish</span><span class="o">=</span><span class="n">squish</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
             <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
             <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
             <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
             <span class="n">xv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xv</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">),</span>
             <span class="n">xId</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xId</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">),</span>
             <span class="n">xJd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xJd</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="p">)</span>
    
    <span class="c1"># Second, save the forward and inverse transform</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
         
        <span class="n">thetab</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@theta</span> <span class="c1"># blur</span>
        <span class="n">Tb</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@T</span> <span class="c1"># blur T</span>
        <span class="n">squishb</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@squish</span> <span class="c1"># blur Squish</span>
    
        <span class="c1"># Compute inverse affine</span>
        <span class="n">Ai</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">Ai</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="o">-</span><span class="n">stretch</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span><span class="nd">@Ai</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ai</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="nd">@XJd</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Ai</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Since these operations do not change the z coordinate, I can interpolate them all at once</span>
        <span class="n">tosample</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Tb</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">squishb</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span><span class="n">thetab</span><span class="p">[</span><span class="kc">None</span><span class="p">]))</span>    
        <span class="n">out</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">xId</span><span class="p">,</span><span class="n">tosample</span><span class="p">,</span><span class="n">Xs</span><span class="p">,</span><span class="n">dd</span><span class="p">)</span>    
        <span class="n">Ts</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">squishs</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    
        <span class="c1"># These variables only need to be computed once</span>
        <span class="n">eye</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">),)[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">zo</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],</span><span class="o">**</span><span class="n">dd</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Ts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">],)</span>
    
        <span class="c1"># Remove the bottom row?</span>
        <span class="n">Tcat</span> <span class="o">=</span>  <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">z</span><span class="p">,</span><span class="n">Ts</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">squishmat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag_embed</span><span class="p">(</span>  <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">squishs</span><span class="p">),(</span><span class="o">-</span><span class="n">squishs</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">(),(</span><span class="n">squishs</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()]</span> <span class="p">,</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">)],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetas</span><span class="p">)],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetas</span><span class="p">)],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">],</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">Xs</span> <span class="o">=</span> <span class="n">Xs</span> <span class="o">-</span> <span class="n">Tcat</span>    
        <span class="n">Xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">rotmat</span><span class="nd">@squishmat@Xs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    
        <span class="c1"># Now compute the diffeo</span>
        <span class="n">phii</span> <span class="o">=</span> <span class="n">phii_from_v</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xv</span><span class="p">,(</span><span class="n">phii</span><span class="o">-</span><span class="n">XV</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">Xs</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">Xs</span>

    <span class="c1"># Save the inverse transform</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;inverse_transform.npz&#39;</span><span class="p">),</span> <span class="n">phii</span><span class="o">=</span><span class="n">Xs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xJd</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>

    <span class="c1"># Generate + save a high res version of the inverse</span>
    <span class="n">XJd_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">XJd</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">XJd</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">])),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Xs_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Xs</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">XJd</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">])),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span> <span class="n">XJd_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="nd">@XJd_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">XJd_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Xs_</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">FIT</span> <span class="o">=</span> <span class="p">(</span><span class="n">fit</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="nd">@XJd_</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">fit</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># hfig = display(fig,display_id=True)</span>
    <span class="n">OUT</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">J</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># get the location</span>
        <span class="n">thisx</span> <span class="o">=</span> <span class="p">[[</span><span class="n">xJ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">thisX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">thisx</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># interpolate Xs, so that now when we fill with zeros, the result will be appropriate</span>
        <span class="n">thisXfit</span> <span class="o">=</span> <span class="p">(</span><span class="n">fit</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="nd">@thisX</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">fit</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>    
        <span class="n">out</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xJd</span><span class="p">,(</span><span class="n">Xs</span><span class="o">-</span><span class="n">FIT</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">thisX</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">))</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">thisXfit</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        
        <span class="n">bad</span> <span class="o">=</span> <span class="n">out</span><span class="o">==</span><span class="mi">0</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xId</span><span class="p">,</span><span class="n">Id</span><span class="p">,</span><span class="n">out</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">out</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">out</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># hfig.update(fig)</span>
    
        <span class="c1"># scale</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">xI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xI</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xI</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">/</span> <span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">xI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xI</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xI</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xI</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xI</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span><span class="o">**</span><span class="n">dd</span><span class="p">))</span>
        <span class="n">OUT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">OUT</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>
    <span class="n">OUT</span> <span class="o">=</span> <span class="n">OUT</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Write it out</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;interpolated_atlas_to_spine_reflection_v04.npy&#39;</span><span class="p">),</span><span class="n">OUT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig13</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig13_interp_atlas_to_spine.png&#39;</span><span class="p">))</span>

    <span class="c1"># Save the forward and inverse transform</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="c1"># blur </span>
        <span class="n">thetab</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@theta</span>
        <span class="c1"># blur T</span>
        <span class="n">Tb</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@T</span>
        <span class="c1"># blur Squish</span>
        <span class="n">squishb</span> <span class="o">=</span> <span class="n">B</span><span class="nd">@squish</span>
    
        <span class="c1"># forward phi</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">phii_from_v</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    
        <span class="c1"># start with XId</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="n">XId</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        
        <span class="c1"># then apply phi</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xv</span><span class="p">,(</span><span class="n">phi</span><span class="o">-</span><span class="n">XV</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">Xs</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">Xs</span>
        
        <span class="c1"># then we can compose the other transformations</span>
        <span class="c1"># since these operations do not change the z coordinate</span>
        <span class="c1"># I can interpolate them all at once</span>
        <span class="n">tosample</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Tb</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">squishb</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span><span class="n">thetab</span><span class="p">[</span><span class="kc">None</span><span class="p">]))</span>    
        <span class="n">out</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">xId</span><span class="p">,</span><span class="n">tosample</span><span class="p">,</span><span class="n">Xs</span><span class="p">,</span><span class="n">dd</span><span class="p">)</span>
        <span class="n">Ts</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">squishs</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    
        <span class="c1"># these guys only need to be computed once</span>
        <span class="n">eye</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">),)[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">zo</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],</span><span class="o">**</span><span class="n">dd</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Ts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">],)</span>
        <span class="n">Tcat</span> <span class="o">=</span>  <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">z</span><span class="p">,</span><span class="n">Ts</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># I&#39;m leaving the sign here the same</span>
        <span class="n">squishmat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag_embed</span><span class="p">(</span>  <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">squishs</span><span class="p">),(</span><span class="n">squishs</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">(),(</span><span class="n">squishs</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()]</span> <span class="p">,</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="c1"># note I deleted the minus sign as compared to above</span>
        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">)],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetas</span><span class="p">)],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="c1"># note I moved the minus sign as compared to above</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetas</span><span class="p">)],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">],</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># before the order was translate, squish, rotate</span>
        <span class="c1"># so now we do, rotate, squish translate</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">squishmat</span><span class="nd">@rotmat@Xs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="n">Xs</span> <span class="o">+</span> <span class="n">Tcat</span>
    
        <span class="c1"># last the affine, and the streching is part of it</span>
        <span class="n">A_</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="nd">@torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">stretch</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span> <span class="o">+</span> <span class="n">A</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">A_</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="nd">@Xs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">A_</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
        
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;forward_transform.npz&#39;</span><span class="p">),</span> <span class="n">phi</span><span class="o">=</span><span class="n">Xs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xId</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>

    <span class="c1"># Now generate + save a high res version of the inverse</span>
    <span class="n">XId_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">XId</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">XId</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">])),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Xs_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Xs</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">XId</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">])),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span> <span class="n">XId_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="nd">@XId_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">XId_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Xs_</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">FIT</span> <span class="o">=</span> <span class="p">(</span><span class="n">fit</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="nd">@XId_</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">3</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">fit</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># hfig = display(fig,display_id=True)</span>
    <span class="n">OUT</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># get the location</span>
        <span class="n">thisx</span> <span class="o">=</span> <span class="p">[[</span><span class="n">xI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]],</span><span class="n">xI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xI</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">thisX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">thisx</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># interpolate Xs</span>
        <span class="n">thisXfit</span> <span class="o">=</span> <span class="p">(</span><span class="n">fit</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span><span class="nd">@thisX</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">fit</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>    
        <span class="n">out</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xId</span><span class="p">,(</span><span class="n">Xs</span><span class="o">-</span><span class="n">FIT</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">thisX</span><span class="p">,</span><span class="o">**</span><span class="n">dd</span><span class="p">))</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">thisXfit</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        
        <span class="n">bad</span> <span class="o">=</span> <span class="n">out</span><span class="o">==</span><span class="mi">0</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xJd</span><span class="p">,</span><span class="n">Jd</span><span class="p">,</span><span class="n">out</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">out</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">out</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># hfig.update(fig)</span>
    
        <span class="c1"># scale</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">xJ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">/</span> <span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">xJ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xJ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xJ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xJ</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xJ</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span><span class="o">**</span><span class="n">dd</span><span class="p">))</span>
        <span class="n">out</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">OUT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">OUT</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>
    <span class="n">OUT</span> <span class="o">=</span> <span class="n">OUT</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig14</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig14_high_res.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig15</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">out</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">out</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig15_high_res0.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">saveAllFigs</span> <span class="ow">or</span> <span class="n">saveFig16</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">Xs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">Xs</span><span class="o">.</span><span class="n">detach</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xs</span><span class="o">.</span><span class="n">detach</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">Xs</span><span class="o">.</span><span class="n">detach</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">Xs</span><span class="o">.</span><span class="n">detach</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;fig16_high_res1.png&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Successfully registered </span><span class="si">{</span><span class="n">fname_J</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">fname_I</span><span class="si">}</span><span class="s1"> and saved all outputs in </span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Spine Image Registration  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spine_reg_pipeline</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Andrew Bennecke.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>