
<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spine_reg &#8212; Spine Image Registration  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../_static/bizstyle.css?v=5283bb3d" />
    
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Spine Image Registration  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spine_reg</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spine_reg</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<div class="viewcode-block" id="draw">
<a class="viewcode-back" href="../spine_reg.html#spine_reg.draw">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">xI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a plot of &#39;I&#39; along the 3 cardinal planes - Coronal, sagittal, and transverse.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    I : array</span>
<span class="sd">        A 3D image volume</span>
<span class="sd">    xI : list of array</span>
<span class="sd">        A list of the coordinates along each dimension of I</span>
<span class="sd">    fig : matplotlib.figure</span>
<span class="sd">        A figure on which new plots will be generated</span>
<span class="sd">    function : Python function</span>
<span class="sd">        Default - np.sum(), will produce a Maximum Intensity Projection; The function used to generate the 3 views of I.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    axs : np.array of matplotlib.axes</span>
<span class="sd">        Each element of axs contains 1 of the 3 cardinal views of I        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nI</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">xI</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nI</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    
    <span class="c1"># Initialize figure</span>
    <span class="n">dI</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xI</span><span class="p">]</span>    
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Generate plot along coronal plane</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="c1"># Generate plot along ?transverse? plane</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="c1"># Generate plot along ?sagittal? plane</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dI</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1"># 12/03/25: Changed return from np.array(axs) to fig, axs. This was done so that a user could save the figure as a png file if desired</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span></div>



<div class="viewcode-block" id="getslice">
<a class="viewcode-back" href="../spine_reg.html#spine_reg.getslice">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">getslice</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a 2D slice of the 3D image volume &#39;I&#39;</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    I : array</span>
<span class="sd">        A 3D image volume</span>
<span class="sd">    ax : int</span>
<span class="sd">        Options : -1, -2, -3; The axis of I from which a slice should be extracted</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    A subset of I along the desired axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">I</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ax</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">I</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:]</span>
    <span class="k">elif</span> <span class="n">ax</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">I</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:]</span>    </div>



<div class="viewcode-block" id="interp">
<a class="viewcode-back" href="../spine_reg.html#spine_reg.interp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interp</span><span class="p">(</span><span class="n">xI</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">Xs</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolate ...</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    xI : list of array</span>
<span class="sd">        A list of the coordinates along each dimension of I</span>
<span class="sd">    I : array</span>
<span class="sd">        A 3D image volume</span>
<span class="sd">    Xs : ...</span>
<span class="sd">        ...</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    output : torch.Tensor</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Xs</span> <span class="o">=</span> <span class="n">Xs</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xI</span><span class="p">])</span>
    <span class="n">Xs</span> <span class="o">=</span> <span class="n">Xs</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xI</span><span class="p">])</span>
    <span class="n">Xs</span> <span class="o">=</span> <span class="n">Xs</span> <span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span><span class="n">Xs</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="interp1d">
<a class="viewcode-back" href="../spine_reg.html#spine_reg.interp1d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interp1d</span><span class="p">(</span><span class="n">xI</span><span class="p">,</span><span class="n">squish</span><span class="p">,</span><span class="n">Xs</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hack for 1D interpolation</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    xI : list of array</span>
<span class="sd">        A list of the coordinates along each dimension of I</span>
<span class="sd">    squish : ...</span>
<span class="sd">        ...</span>
<span class="sd">    Xs : ...</span>
<span class="sd">        ...</span>
<span class="sd">    dd : dict</span>
<span class="sd">        A Python dictionary with 2 keys \&#39;device\&#39; and \&#39;dtype\&#39;, which specifies those 2 PyTorch paremeters for computation</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    output : ...</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up a hack for 1d interplation    </span>
    <span class="c1"># grid sample supports 2D</span>
    <span class="c1"># Mke it 2d + use the slice coordinate as the first coordinate, and zeros as the second fake coordinate    </span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Xs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Xs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># for the input, we keep the channel dimension, keep the first coordinate, and add a fake second coordinate</span>
    <span class="n">squishin</span> <span class="o">=</span> <span class="n">squish</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">interp</span><span class="p">([</span><span class="n">xI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],</span><span class="o">**</span><span class="n">dd</span><span class="p">)],</span><span class="n">squishin</span><span class="p">,</span><span class="n">samples</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">squish</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span><span class="o">+</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>    </div>



<span class="c1"># we need integration of v, note there is NO batch dimension</span>
<div class="viewcode-block" id="phii_from_v">
<a class="viewcode-back" href="../spine_reg.html#spine_reg.phii_from_v">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">phii_from_v</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    xv : list of torch.Tensor</span>
<span class="sd">        ...</span>
<span class="sd">    v : torch.Tensor</span>
<span class="sd">        ...</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    phii : torch.Tensor</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">XV</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">phii</span> <span class="o">=</span> <span class="n">XV</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="c1">#.repeat((v.shape[0],1,1,1))</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="n">XV</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span> <span class="c1"># Xs should have a batch dimension        </span>
        <span class="n">phii</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xv</span><span class="p">,(</span><span class="n">phii</span><span class="o">-</span><span class="n">XV</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">Xs</span><span class="p">,</span><span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">Xs</span>
    <span class="k">return</span> <span class="n">phii</span></div>



<div class="viewcode-block" id="toblocks">
<a class="viewcode-back" href="../spine_reg.html#spine_reg.toblocks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">toblocks</span><span class="p">(</span><span class="n">Jd</span><span class="p">,</span><span class="n">blocksize</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    Jd : torch.Tensor</span>
<span class="sd">        A 3D image volume with 1 additional batch dimension</span>
<span class="sd">    blocksize : int</span>
<span class="sd">        ...</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    Jdpp : ...</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nblocks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">Jd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span><span class="o">/</span><span class="n">blocksize</span> <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">topad</span> <span class="o">=</span> <span class="n">nblocks</span><span class="o">*</span><span class="n">blocksize</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">Jd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">topadlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">topad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">topad</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">topad</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># this pads the left</span>
    <span class="n">Jdp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">Jd</span><span class="p">,</span><span class="n">topadlist</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
    <span class="n">Jdpv</span> <span class="o">=</span> <span class="n">Jdp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Jdp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nblocks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">blocksize</span><span class="p">,</span><span class="n">nblocks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">blocksize</span><span class="p">,</span><span class="n">nblocks</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">blocksize</span><span class="p">)</span>
    <span class="n">Jdpp</span> <span class="o">=</span> <span class="n">Jdpv</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Jdpp</span></div>



<div class="viewcode-block" id="fromblocks">
<a class="viewcode-back" href="../spine_reg.html#spine_reg.fromblocks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fromblocks</span><span class="p">(</span><span class="n">fphiIpp</span><span class="p">,</span><span class="n">Jdsize</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    fphiIpp : ...</span>
<span class="sd">        ...</span>
<span class="sd">    Jdsize : torch.Tensor</span>
<span class="sd">        The shape of the downsampled target data</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    output : ...</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># undo the permutation</span>
    <span class="n">blocksize</span> <span class="o">=</span> <span class="n">fphiIpp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nblocks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">Jdsize</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:],</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span><span class="o">/</span><span class="n">blocksize</span> <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1">#print(nblocks)</span>
    <span class="n">topad</span> <span class="o">=</span> <span class="n">nblocks</span><span class="o">*</span><span class="n">blocksize</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">Jdsize</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:],</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">fphiIpv</span> <span class="o">=</span> <span class="n">fphiIpp</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="c1"># NOTE THIS SIZE 1 IS HARD CODED</span>
    <span class="n">fphiIp</span> <span class="o">=</span> <span class="n">fphiIpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nblocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">blocksize</span><span class="p">,</span><span class="n">nblocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">blocksize</span><span class="p">,</span><span class="n">nblocks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">blocksize</span><span class="p">)</span>
    <span class="c1">#return fphiIp[:,:Jdsize[-3],:Jdsize[-2],:Jdsize[-1]]</span>
    <span class="k">return</span> <span class="n">fphiIp</span><span class="p">[:,</span><span class="n">topad</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,</span><span class="n">topad</span><span class="p">[</span><span class="mi">1</span><span class="p">]:,</span><span class="n">topad</span><span class="p">[</span><span class="mi">2</span><span class="p">]:]</span></div>



<div class="viewcode-block" id="measure_matching_dot">
<a class="viewcode-back" href="../spine_reg.html#spine_reg.measure_matching_dot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">measure_matching_dot</span><span class="p">(</span><span class="n">qIU</span><span class="p">,</span><span class="n">wIU</span><span class="p">,</span><span class="n">phiiQJU</span><span class="p">,</span><span class="n">wphiiQJU</span><span class="p">,</span><span class="n">SigmaQIU</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    qIU : ...</span>
<span class="sd">        ...</span>
<span class="sd">    wIU : ...</span>
<span class="sd">        ...</span>
<span class="sd">    phiiQJU : ...</span>
<span class="sd">        ...</span>
<span class="sd">    wphiiQJU : ...</span>
<span class="sd">        ...</span>
<span class="sd">    SigmaQIU : ...</span>
<span class="sd">        ...</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    output : ...</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">qIU</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">phiiQJU</span><span class="p">[</span><span class="kc">None</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">SigmaQIU</span> <span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">wIU</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">wphiiQJU</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">K</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Spine Image Registration  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spine_reg</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Andrew Bennecke.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>